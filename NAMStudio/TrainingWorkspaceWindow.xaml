<Window x:Class="NAMStudio.TrainingWorkspaceWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Training Workspace" Height="780" Width="1220">
    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <DockPanel Grid.Row="0" LastChildFill="False" Margin="0,0,0,8">
            <TextBlock Text="Configure NAM training, adjust metadata, and review run history." VerticalAlignment="Center" />
            <Button Content="Start New Training" Command="{Binding StartTrainingCommand}" Margin="12,0,0,0" Padding="12,6" />
            <Button Content="Open Selected Details" Command="{Binding OpenRunDetailsCommand}" Margin="12,0,0,0" Padding="12,6" />
        </DockPanel>

        <TabControl Grid.Row="1">
            <TabItem Header="Run Training">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <Grid Margin="8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="2*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Margin="0,0,12,0">
                            <GroupBox Header="Waveforms">
                                <StackPanel Margin="8">
                                    <StackPanel Orientation="Horizontal">
                                        <Button Content="Load Input" Command="{Binding BrowseInputWaveformCommand}" Padding="10,6" />
                                        <TextBlock Text="{Binding InputWaveformPath}" Margin="8,0,0,0" VerticalAlignment="Center" TextTrimming="CharacterEllipsis" />
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal">
                                        <Button Content="Load Target" Command="{Binding BrowseTargetWaveformCommand}" Padding="10,6" />
                                        <TextBlock Text="{Binding TargetWaveformPath}" Margin="8,0,0,0" VerticalAlignment="Center" TextTrimming="CharacterEllipsis" />
                                    </StackPanel>
                                </StackPanel>
                            </GroupBox>

                            <GroupBox Header="NAM Metadata" Margin="0,8,0,0">
                                <Grid Margin="8">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="140" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Text="Model Name" Grid.Row="0" Grid.Column="0" VerticalAlignment="Center" />
                                    <TextBox Text="{Binding TrainingMetadata.ModelName, UpdateSourceTrigger=PropertyChanged}" Grid.Row="0" Grid.Column="1" Margin="4" />

                                    <TextBlock Text="Artist" Grid.Row="1" Grid.Column="0" VerticalAlignment="Center" />
                                    <TextBox Text="{Binding TrainingMetadata.Artist, UpdateSourceTrigger=PropertyChanged}" Grid.Row="1" Grid.Column="1" Margin="4" />

                                    <TextBlock Text="Genre" Grid.Row="2" Grid.Column="0" VerticalAlignment="Center" />
                                    <TextBox Text="{Binding TrainingMetadata.Genre, UpdateSourceTrigger=PropertyChanged}" Grid.Row="2" Grid.Column="1" Margin="4" />

                                    <TextBlock Text="Amp" Grid.Row="3" Grid.Column="0" VerticalAlignment="Center" />
                                    <TextBox Text="{Binding TrainingMetadata.Amp, UpdateSourceTrigger=PropertyChanged}" Grid.Row="3" Grid.Column="1" Margin="4" />

                                    <TextBlock Text="Cabinet" Grid.Row="4" Grid.Column="0" VerticalAlignment="Center" />
                                    <TextBox Text="{Binding TrainingMetadata.Cabinet, UpdateSourceTrigger=PropertyChanged}" Grid.Row="4" Grid.Column="1" Margin="4" />

                                    <TextBlock Text="Microphone" Grid.Row="5" Grid.Column="0" VerticalAlignment="Center" />
                                    <TextBox Text="{Binding TrainingMetadata.Microphone, UpdateSourceTrigger=PropertyChanged}" Grid.Row="5" Grid.Column="1" Margin="4" />

                                    <TextBlock Text="Session Id" Grid.Row="6" Grid.Column="0" VerticalAlignment="Center" />
                                    <TextBox Text="{Binding TrainingMetadata.SessionId, UpdateSourceTrigger=PropertyChanged}" Grid.Row="6" Grid.Column="1" Margin="4" />

                                    <TextBlock Text="Notes" Grid.Row="7" Grid.Column="0" VerticalAlignment="Top" />
                                    <TextBox Text="{Binding TrainingMetadata.Notes, UpdateSourceTrigger=PropertyChanged}" Grid.Row="7" Grid.Column="1" Margin="4" AcceptsReturn="True" Height="80" TextWrapping="Wrap" />
                                </Grid>
                            </GroupBox>

                            <GroupBox Header="Training Parameters" Margin="0,8,0,0">
                                <Grid Margin="8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="160" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="80" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <TextBlock Text="Epochs" Grid.Row="0" Grid.Column="0" VerticalAlignment="Center" />
                                    <Slider Minimum="1" Maximum="300" Value="{Binding TrainingParameters.Epochs}" Grid.Row="0" Grid.Column="1" Margin="4" />
                                    <TextBlock Text="{Binding TrainingParameters.Epochs}" Grid.Row="0" Grid.Column="2" VerticalAlignment="Center" />

                                    <TextBlock Text="Batch Size" Grid.Row="1" Grid.Column="0" VerticalAlignment="Center" />
                                    <Slider Minimum="1" Maximum="96" Value="{Binding TrainingParameters.BatchSize}" Grid.Row="1" Grid.Column="1" Margin="4" />
                                    <TextBlock Text="{Binding TrainingParameters.BatchSize}" Grid.Row="1" Grid.Column="2" VerticalAlignment="Center" />

                                    <TextBlock Text="Learning Rate" Grid.Row="2" Grid.Column="0" VerticalAlignment="Center" />
                                    <Slider Minimum="0.00005" Maximum="0.01" Value="{Binding TrainingParameters.LearningRate}" Grid.Row="2" Grid.Column="1" Margin="4" />
                                    <TextBlock Text="{Binding TrainingParameters.LearningRate, StringFormat=0.0000}" Grid.Row="2" Grid.Column="2" VerticalAlignment="Center" />

                                    <TextBlock Text="Train Split" Grid.Row="3" Grid.Column="0" VerticalAlignment="Center" />
                                    <Slider Minimum="0.5" Maximum="0.95" Value="{Binding TrainingParameters.TrainSplit}" Grid.Row="3" Grid.Column="1" Margin="4" />
                                    <TextBlock Text="{Binding TrainingParameters.TrainSplit, StringFormat=P0}" Grid.Row="3" Grid.Column="2" VerticalAlignment="Center" />

                                    <TextBlock Text="Validation Split" Grid.Row="4" Grid.Column="0" VerticalAlignment="Center" />
                                    <Slider Minimum="0.05" Maximum="0.5" Value="{Binding TrainingParameters.ValidationSplit}" Grid.Row="4" Grid.Column="1" Margin="4" />
                                    <TextBlock Text="{Binding TrainingParameters.ValidationSplit, StringFormat=P0}" Grid.Row="4" Grid.Column="2" VerticalAlignment="Center" />

                                    <TextBlock Text="Sample Rate" Grid.Row="5" Grid.Column="0" VerticalAlignment="Center" />
                                    <TextBox Text="{Binding TrainingParameters.SampleRate}" Grid.Row="5" Grid.Column="1" Margin="4" />

                                    <TextBlock Text="Block Size" Grid.Row="6" Grid.Column="0" VerticalAlignment="Center" />
                                    <TextBox Text="{Binding TrainingParameters.BlockSize}" Grid.Row="6" Grid.Column="1" Margin="4" />

                                    <TextBlock Text="L2 Regularization" Grid.Row="7" Grid.Column="0" VerticalAlignment="Center" />
                                    <TextBox Text="{Binding TrainingParameters.L2Regularization}" Grid.Row="7" Grid.Column="1" Margin="4" />

                                    <TextBlock Text="Optimizer" Grid.Row="8" Grid.Column="0" VerticalAlignment="Center" />
                                    <ComboBox SelectedValue="{Binding TrainingParameters.Optimizer}" SelectedValuePath="Content" Grid.Row="8" Grid.Column="1" Margin="4">
                                        <ComboBoxItem Content="Adam" />
                                        <ComboBoxItem Content="AdamW" />
                                        <ComboBoxItem Content="SGD" />
                                    </ComboBox>

                                    <CheckBox Content="Normalize input" IsChecked="{Binding TrainingParameters.NormalizeInput}" Grid.Row="9" Grid.Column="0" Margin="4" />
                                    <CheckBox Content="Enable augmentation" IsChecked="{Binding TrainingParameters.UseAugmentation}" Grid.Row="9" Grid.Column="1" Margin="4" />

                                    <StackPanel Grid.Row="10" Grid.Column="0" Grid.ColumnSpan="2" Orientation="Horizontal" Margin="0,4,0,0">
                                        <CheckBox Content="Early stopping" IsChecked="{Binding TrainingParameters.EarlyStopping}" />
                                        <TextBlock Text="Patience" Margin="12,0,4,0" VerticalAlignment="Center" />
                                        <TextBox Text="{Binding TrainingParameters.EarlyStoppingPatience}" Width="60" />
                                    </StackPanel>
                                </Grid>
                            </GroupBox>

                            <Button Content="Train and Export NAM" Command="{Binding StartTrainingCommand}" HorizontalAlignment="Left" Padding="14,8" Margin="0,10,0,0" />
                        </StackPanel>

                        <StackPanel Grid.Column="1">
                            <GroupBox Header="Run Queue">
                                <DataGrid ItemsSource="{Binding TrainingRuns}" SelectedItem="{Binding SelectedTrainingRun}" AutoGenerateColumns="False" CanUserAddRows="False" Margin="8" Height="360">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Created" Binding="{Binding CreatedAt, StringFormat=G}" Width="150" />
                                        <DataGridTextColumn Header="Model" Binding="{Binding Metadata.ModelName}" Width="140" />
                                        <DataGridTextColumn Header="Input" Binding="{Binding InputWaveformPath}" Width="180" />
                                        <DataGridTextColumn Header="Target" Binding="{Binding TargetWaveformPath}" Width="180" />
                                        <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="90" />
                                        <DataGridTextColumn Header="NAM File" Binding="{Binding NamFilePath}" Width="200" />
                                    </DataGrid.Columns>
                                </DataGrid>
                            </GroupBox>

                            <GroupBox Header="Status" Margin="0,8,0,0">
                                <StackPanel Margin="8">
                                    <TextBlock Text="{Binding StatusMessage}" />
                                    <TextBlock Text="{Binding SelectedTrainingRun.StatusMessage}" TextWrapping="Wrap" />
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>
                    </Grid>
                </ScrollViewer>
            </TabItem>

            <TabItem Header="Runs Files">
                <StackPanel Margin="8">
                    <DataGrid ItemsSource="{Binding TrainingRuns}" SelectedItem="{Binding SelectedTrainingRun}" AutoGenerateColumns="False" CanUserAddRows="False" Height="420">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Created" Binding="{Binding CreatedAt, StringFormat=G}" Width="140" />
                            <DataGridTextColumn Header="Model" Binding="{Binding Metadata.ModelName}" Width="150" />
                            <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="90" />
                            <DataGridTextColumn Header="Final Loss" Binding="{Binding FinalLoss}" Width="90" />
                            <DataGridTextColumn Header="Val Loss" Binding="{Binding ValidationLoss}" Width="90" />
                            <DataGridTextColumn Header="SNR (dB)" Binding="{Binding SignalToNoiseRatio}" Width="90" />
                            <DataGridTextColumn Header="Input File" Binding="{Binding InputWaveformPath}" Width="220" />
                            <DataGridTextColumn Header="Target File" Binding="{Binding TargetWaveformPath}" Width="220" />
                            <DataGridTextColumn Header="NAM File" Binding="{Binding NamFilePath}" Width="220" />
                        </DataGrid.Columns>
                    </DataGrid>
                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                        <Button Content="View Details" Command="{Binding OpenRunDetailsCommand}" CommandParameter="{Binding SelectedTrainingRun}" Padding="12,6" />
                        <Button Content="Start Another" Command="{Binding StartTrainingCommand}" Padding="12,6" Margin="8,0,0,0" />
                    </StackPanel>
                </StackPanel>
            </TabItem>
        </TabControl>
    </Grid>
</Window>
